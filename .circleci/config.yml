# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

commands:
    rust_version:
        description: Rust toolchain version
        steps:
            - run:
                name: Toolchain version
                command: |
                    rustup --version
                    cargo --version
                    rustc --version

jobs:
    build_rust_docker:
        machine:
            docker_layer_caching: true
        steps:
            - checkout
            - run:
                name: Build Rust image
                command: |
                    IMAGE="hashedone/rust-convenience-alpine"
                    TAG="dwarf-miners-${CIRCLE_BUILD_NUM}"
                    docker build -t $IMAGE:$TAG docker/rust-alpine/
                    docker tag $IMAGE:TAG $IMAGE:dwarf-miners
                    docker login -u $DOCKER_USER -p $DOCKER_PWD
                    docker push $IMAGE:TAG
                    docker push $IMAGE:dwarf-miners

    build_rust_workspace:
        docker:
            - image: circleci/rust:latest
        steps:
            - rust_version
            - checkout
            - run:
                name: Check build
                command: cargo check --all

    rust_workspace_clippy:
        docker:
            - image: circleci/rust:latest
        steps:
            - rust_version
            - checkout
            - run:
                name: Check clippy
                command: cargo clippy --all

    rust_workspace_fmt:
        docker:
            - image: circleci/rust:latest
        steps:
            - rust_version
            - checkout
            - run:
                name: Check formatting
                command: cargo fmt --all -- --check

    rust_workspace_tests:
        docker:
            - image: circleci/rust:latest
        steps:
            - rust_version
            - checkout
            - run:
                name: Check tests
                command: cargo test --all

workflows:
    version: 2
    dockers:
        jobs:
            - build_rust_docker
    rust:
        jobs:
            - build_rust_workspace
            - rust_workspace_clippy:
                requires:
                    - build_rust_workspace
            - rust_workspace_fmt:
                requires:
                    - build_rust_workspace
            - rust_workspace_tests:
                requires:
                    - build_rust_workspace

